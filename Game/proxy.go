package main

import (
	//"encoding/hex"
	"fmt"
	"time"

	"../common/packet"
)

// Pong ... tm(Q) when(Q) elapsed(Q) remote(Q) local(I) world(I)
func (sess *Session) Pong(reader *packet.Reader) {
	tm := reader.Long()
	when := reader.Long()
	local := reader.Int()

	w := packet.CreateProxyWriter(19)
	w.Long(tm)
	w.Long(when)
	w.Long(123)                              // elapsed
	w.Long(uint64(time.Now().Unix()) * 1000) // remote
	w.UInt(uint32(local))
	w.UInt(uint32(time.Now().Unix())) // world
	w.Send(sess.conn)
}

// ChangeState ... State(I)
func (sess *Session) ChangeState(state uint32) {
	w := packet.CreateProxyWriter(0)
	w.UInt(state)
	w.Send(sess.conn)
}

// FinishState ... State(I)
func (sess *Session) FinishState(reader *packet.Reader) {
	state := reader.Int()
	fmt.Println("[PROXY] State: ", state)

	switch state {
	case 0:
		sess.ChangeState(1)
		sess.SCHackGuardRetAddrsRequestPacket(true, false, true, false)
		sess.SetGameType("e_rainbow_field_3", 0, 1)
		sess.SCInitialConfigPacket()
		sess.SCTrionConfigPacket(true, "https://session.draft.integration.triongames.priv", "https://archeage.draft.integration.triongames.priv/commerce/purchase/credits/purchase-credits-flow.action")
		// TODO: Payment should be datetime
		sess.SCAccountInfoPacket(0, 0, 0, 0x5460)
		sess.SCChatSpamConfigPacket()
		sess.SCAccountAttributeConfigPacket()
		sess.SCLevelRestrictionConfigPacket(10, 10, 10, 10, 10)
		sess.SCTaxItemConfigPacket(0)
		sess.SCInGameShopConfigPacket(1, 2, 0)
		sess.SCGameRuleConfigPacket(0, 0)
		sess.SCUnknownPacket0x215(1, time.Now().Unix())
		sess.SCTaxItemConfig2Packet(0)
	case 1:
		sess.ChangeState(2)
		//sess.State2()
	case 2:
		sess.ChangeState(3)
		//sess.State3()
	case 3:
		sess.ChangeState(4)
		//sess.State4()
	case 4:
		sess.ChangeState(5)
		//sess.State5()
	case 5:
		sess.ChangeState(6)
		//sess.State6()
	case 6:
		sess.ChangeState(7)
		sess.State7()
	default:
		fmt.Println("[PROXY, err] No such state:", state)
	}
}

// SetGameType ...
func (sess *Session) SetGameType(level string, checksum uint64, immersive byte) {
	w := packet.CreateProxyWriter(0xF)
	w.String(level)
	w.Long(checksum)
	w.Byte(immersive)
	w.Send(sess.conn)
}

func (sess *Session) State7() {
	w := packet.CreateWriter(0)
	payload := "7a02dd0511704c91c41a00dfa2362b7485dae63b4698a8f9055a055f36774516e6b6865627f7c7976078bcab194739bfe6b28252a2cdc3939cccfc2caf744414e4b59d545ab8c6967a5506d7bc754717f0c0906033cac1a1714112e2b2825323f3c393643404d4a4754515e5b5825626f6c697673707d7a0704010608e815121f1c292e20d02d3234c4313e4b4845425f5c195d937acd6a6764717e7b78760307eefa071c12ee1b1026dad30f7ac633383eca474c42be4b5056ac68e4d69c9dae928089ba8efb8f8b8af21f1c191e132023da29d43fde3b2805424f4c494652405d5a57646e8e6b0bcee272fc74e709410c8aa6ab02116c262551103d3a3734370e4b4845425f5c5f165360626a6764717e7b7877bf5f0c090053101d1a18b4212e252835323f3c394643404d4a5754515e6b6865626f7c797673710e0b0805021f1c191613202d2a2724313e3b3835424f4c41cf53505d5d87646e919b6875726f7c0906030ff05e771412ec3b2825222f3c3f6633304d4a4744415e595855526f6c69666370728a77750200fc0906131fed1a17242ede2b38353dcf3c49464cb04d5a575ba15e6b686a926f7c7979837fed0a08f4011e1b17e5023f2c292623303d3a3734414e4b4845525f5c596663606d6a7774717e7c0906030fed1a1714111e2b2825222f3c393633304d4a4744415e5b5855526f6c696663707d7a7774010e0b0815121f1c1927c0e30d28b174413e2b4845424f4c595653505d6a6764616e7b7875727fed0a0704011e1b1815122f2c292623303d3a3744414e4b4855525f5c797663606d6025c4617e7b0805121f0c191613101d0a9603813e3b3815323f4c4314f3505d5a5754717e6b7a61927f7c796074911e0b081510e00dd055ba6c6c797704010e0b081510a00dd050bf23311e0b081511600dd05a526e447b4891ec7def529fd97704010e0b041105200dd05ff65e7805022f2c2c2102503faa3a4dac45e65058590244447e4e6bb0619a6c6c665603870f055112fb0b2d16d73f692ac323353e7f34477946434cd493f311845e7f3722adbb54cfb490010b0c297512900dd05f727814210dab383532380c09464bae416fe754516e6bc942d27f7b39370409e0173da510131610f00dd05e2a195c70736d112e0b08151861500dd05ec619b86df27f7c797704010e0b081514575a53100dd0504a891c091613101d2a2724212e3b3835323f4c494643405d5a5754516e6b6865727f7c797704010e0b0815180b0e7"
	if sess.accountID == 2 {
		payload = "8002dd054f350d50c7e3c083616368a4c70136618bd2ee3a5195a0f801596bd523c54716e6b6865627f7c79760300b7ad91374698ac281522272fd9263ccfc2c5b7e4414e4b5854d248b8b96667358d7a76f4517f0c0906030020ca3714112e2b2825323f3c393643404d4a4754515e5b5865726f6c697673707d7a0704010e031be5121f1c29262b23dd3a3f37c13e4b4845425f5c5c5653636d40c744717e7b7877d30fed0204e4111618e8252a2cdc293e30c03d3244b4414648a8555a5cac69666365c625f881da5184fbc73210ea1af29cd82d2a2874313f26f835f24f4c494723505d5a576b535e6b687571af7c7a0704010e0b1815121f1c292623203d3a3734314e4b5845425f5c595653606d6a6764717e7b7875020f0c090613101d1a1724212e2b2835323f3c394643404d4a5754515e6b6865626f7c797673710e0b0805021f1c191613202d2a2724313e3b3835424f4c49465bd95d5a5763b16e649785727f7c1906030fed1a0a50711e289935222f3c393635604d4a4744415e5b5857526f6c696663707d7a7885020f0c06f613101d15e724212e24c835323f33b946434042aa575451519b686562608c797673701d0a07040eee1b18151ddf3c392623303d3a3734414e4b4845525f5c596663606d6a7774717e7c0906030fed1a1714111e2b2825222f3c393633304d4a4744415e5b5855526f6c696663707d7a7774010e0b0815121f1c19262321cee91736b77e4b4855424f4c595653505d6a6764616e7b7875727fed0a0704011e1b1815122f2c292623303d3a3744414e4b4855525f5c596643706d6a777a004e6b0805020f1c091613101d2a270490099b2835321f4c49464d316d4a5754616e7b7865607b9c797704167e9b1815107370e00dd05eea1c6c797704010e0b081510a00dd05eef73311e0b081511600dd058b2de4474f1476b986562dfd97704010e0b041105200dd057c68e7805022f2c2a4152403faa3a4dac45e65058590244447e4e6bb0619a6c6c665603870f055112fb0b2d16d73f692ac323353e7f3447794643413d53e310b87e7f3722adbb54cfb490010d6c796511800dd05be2f864517eca4fc57271bc39770d53d1ceb815105340f00dd05bbac95c7c7e9dc16e0b08151861500dd050f6a9b86df27f7c797704010e0b081514575a53100dd0553ad91c091613101d2a2724212e3b3835323f4c494643405d5a5754516e6b6865727f7c797704010e0b0815180b0e7"
	}
	w.HexString(payload)
	w.SendRaw(sess.conn)
	w = packet.CreateWriter(0)
	if sess.accountID == 2 {
		payload = "2900dd05422cb6421204a082d593f6c473773506d5a575602fe6b6875627f7c797704110e0b08151013161"
		*sess.conn.encSeq = 143
	} else {
		payload = "2900dd05c42bb64212469882d9b0f6c4314f3506d5a575602fe6b6875627f7c797704110e0b08151013161"
		*sess.conn.encSeq = 138
	}
	w.HexString(payload)
	w.SendRaw(sess.conn)
	sess.ingame = true
	if sess.accountID == 1 {
		sess.MovePlayer(0x12ba5, 8020487, 7752959, 221215)
	} else {
		sess.MovePlayer(0x113e7, 8020487, 7752959, 221215)
	} // e71301
}
